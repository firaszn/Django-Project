<div id="calendar-widget" class="container mt-3" style="max-width:340px;">
  <div class="card">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <button id="cal-prev" class="btn btn-sm btn-outline-secondary">‹</button>
        <div>
          <strong id="cal-month-year">Month</strong>
          <div class="small text-muted" id="cal-encourage">&nbsp;</div>
        </div>
        <button id="cal-next" class="btn btn-sm btn-outline-secondary">›</button>
      </div>

      <div id="cal-grid" style="display:grid; grid-template-columns: repeat(7, 1fr); gap:6px;">
        <!-- Weekday headers -->
      </div>
      <div class="mt-2 small text-muted">Click a day to view entries.</div>
    </div>
  </div>
</div>

<style>
  #calendar-widget .day-cell { padding:8px; text-align:center; border-radius:8px; }
  #calendar-widget .day-cell.disabled { color:#b3b3b3; }
  /* Active day: use gold accent instead of purple to avoid purple usage in calendar */
  /* Active day: use gold accent instead of purple to avoid purple usage in calendar */
  #calendar-widget .day-cell.active {
    background: linear-gradient(135deg, #FFD76D, #FFE7A8) !important;
    background-image: linear-gradient(135deg, #FFD76D, #FFE7A8) !important;
    color: #2b2b2b !important;
    font-weight: 700 !important;
  }

  /* Force all calendar buttons to white background (no purple). High-specificity + !important to override global .btn rules */
  #calendar-widget .card .btn,
  #calendar-widget button,
  #calendar-widget .btn-sm,
  #calendar-widget .btn-outline-secondary {
    background: #ffffff !important;
    background-image: none !important;
    color: #2b2b2b !important;
    border-color: rgba(0,0,0,0.06) !important;
    box-shadow: none !important;
  }

  /* Remove decorative pseudo-element overlays from buttons (some global rules use ::before gradients) */
  #calendar-widget .card .btn::before,
  #calendar-widget button::before,
  #calendar-widget .btn-sm::before,
  #calendar-widget .btn-outline-secondary::before {
    display: none !important;
    background: none !important;
  }

  /* Ensure button icons inherit the button text color */
  #calendar-widget .card .btn i,
  #calendar-widget button i {
    color: inherit !important;
  }

  /* Override inline gradient backgrounds applied via JS/inline styles (e.g., element.style with linear-gradient) */
  #calendar-widget [style*="linear-gradient"] {
    background: #bfa8ff !important;
    background-image: none !important;
    border-color: rgba(0,0,0,0.06) !important;
    box-shadow: none !important;
    color: #2b2b2b !important;
  }
  #calendar-widget .day-cell .count { display:block; font-size:0.75rem; }

  /* Force readable dark text for all calendar content (day numbers, counts, headers) */
  #calendar-widget,
  #calendar-widget .card,
  #calendar-widget .day-cell,
  #calendar-widget .day-cell > div,
  #calendar-widget .day-cell .count,
  #calendar-widget #cal-month-year,
  #calendar-widget #cal-encourage,
  #calendar-widget .text-muted {
    color: #2b2b2b !important;
  }

  /* Make disabled look muted but still readable */
  #calendar-widget .day-cell.disabled { color: #8a8a8a !important; }

  /* Extra strong fallback for day number elements (catch deeply-specific overrides) */
  #calendar-widget .day-cell > div,
  #calendar-widget .day-cell > div * {
    color: #2b2b2b !important;
    opacity: 1 !important;
    background: transparent !important;
    background-image: none !important;
    font-size: 14px !important;
    line-height: 1 !important;
    display: block !important;
    -webkit-text-fill-color: #2b2b2b !important;
    text-shadow: none !important;
  }
</style>

<script>
(function(){
  const container = document.getElementById('calendar-widget');
  if(!container) return;

  const grid = container.querySelector('#cal-grid');
  const monthYear = container.querySelector('#cal-month-year');
  const encourage = container.querySelector('#cal-encourage');
  const prevBtn = container.querySelector('#cal-prev');
  const nextBtn = container.querySelector('#cal-next');

  const weekdays = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];

  // render weekday headers
  function renderWeekHeaders(){
    grid.innerHTML = '';
    for(let wd of weekdays){
      const h = document.createElement('div');
      h.className = 'text-center small text-muted';
      h.style.fontWeight='600';
      h.textContent = wd;
      grid.appendChild(h);
    }
  }

  let state = { year: null, month: null, days: {} };

  function fetchData(year, month){
    const url = `{% url 'journal_calendar_data' %}?year=${year}&month=${month}`;
    return fetch(url, { credentials: 'same-origin' }).then(r=>r.json());
  }

  function renderCalendar(data){
    // update headers
    const y = data.year; const m = data.month;
    const dt = new Date(y, m-1, 1);
    const formatter = dt.toLocaleString(undefined, { month: 'long' });
    monthYear.textContent = `${formatter} ${y}`;
    encourage.textContent = data.message;

    // map days
    const dayMap = {};
    for(const d of data.days){ dayMap[d.day] = d.count; }
    state.days = dayMap;

    renderWeekHeaders();

    const firstWeekday = new Date(y,m-1,1).getDay(); // 0 Sun .. 6 Sat
    // We want Monday as first column; transform
    const offset = (firstWeekday + 6) % 7;
    const total = data.days_in_month;

    // add blank cells for offset
    for(let i=0;i<offset;i++){
      const cell = document.createElement('div');
      cell.className='day-cell disabled';
      grid.appendChild(cell);
    }

    for(let d=1; d<=total; d++){
        const cell = document.createElement('div');
        cell.className='day-cell';
        cell.innerHTML = `<div>${d}</div>`;

        // Ensure the day number itself is explicitly visible (override any text-fill / opacity rules)
        const numDiv = cell.querySelector('div');
        if(numDiv){
          numDiv.style.setProperty('color', '#2b2b2b', 'important');
          numDiv.style.setProperty('-webkit-text-fill-color', '#2b2b2b', 'important');
          numDiv.style.setProperty('opacity', '1', 'important');
          numDiv.style.setProperty('text-shadow', 'none', 'important');
        }
      if(dayMap[d]){
        cell.classList.add('active');
  const c = document.createElement('span');
  c.className='count';
  c.textContent = `${dayMap[d]} entry${dayMap[d] > 1 ? 'ies' : ''}`;
  // Make count text clearly readable
  c.style.setProperty('color', '#2b2b2b', 'important');
  c.style.setProperty('opacity', '1', 'important');
  c.style.setProperty('text-shadow', 'none', 'important');
  cell.appendChild(c);
      }

      cell.addEventListener('click', ()=>{
        // open filtered journal list for that date
        const url = new URL(window.location.origin + `{% url 'journal_list' %}`);
        url.searchParams.set('year', y);
        url.searchParams.set('month', m);
        url.searchParams.set('day', d);
        window.location.href = url.toString();
      });

      grid.appendChild(cell);
    }
  }

  function goto(year, month){
    fetchData(year, month).then(data=>{
      state.year = data.year; state.month = data.month;
      renderCalendar(data);
    }).catch(err=>{
      console.error('Calendar load error', err);
    });
  }

  // init to current month
  const now = new Date();
  goto(now.getFullYear(), now.getMonth()+1);

  prevBtn.addEventListener('click', ()=>{
    let y = state.year, m = state.month - 1;
    if(m < 1){ m = 12; y -= 1; }
    goto(y,m);
  });
  nextBtn.addEventListener('click', ()=>{
    let y = state.year, m = state.month + 1;
    if(m > 12){ m = 1; y += 1; }
    goto(y,m);
  });

})();
</script>
