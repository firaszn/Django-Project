{% extends "base.html" %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "Home" %} - mindmuse{% endblock %}

{% block content %}
<!-- Hero Section Spectaculaire -->
<div class="hero-section py-5 mt-5">
    <div class="container">
        <div class="row align-items-center min-vh-75">
            <div class="col-lg-6" data-aos="fade-right" data-aos-delay="100">
                <div class="hero-content">
                    <div class="welcome-hero">
                        <h1 class="display-5 fw-bold mb-3">
                            Welcome back {{ user.first_name|default:user.get_full_name|default:user.username }}, what's on your mind today
                        </h1>
                        <p class="lead mb-3 fs-5">
                            {% trans "Write about your thoughts and feelings, have a look at your growth" %}
                        </p>
                        <div class="hero-buttons d-flex gap-3 flex-wrap mt-3">
                            <a href="{% url 'journal_create' %}" class="btn btn-primary">
                                <i class="fas fa-plus me-2"></i>{% trans "New Entry" %}
                            </a>
                            <a href="{% url 'journal_garden' %}" class="btn btn-lavender">
                                <i class="fas fa-seedling me-2"></i>{% trans "Explore Garden" %}
                            </a>
                        </div>
                    </div>
                    
                </div>
            </div>
            <div class="col-lg-6" data-aos="fade-left" data-aos-delay="200">
                <div class="hero-visual text-center">
                    <div class=" d-flex align-items-center justify-content-center">
                        <div class=" float" style="width:360px; height:360px; display:flex; align-items:center; justify-content:center; padding:0; overflow:hidden;">
                            <img src="/media/journal_images/575168236_1627255508648579_8849449453421605306_n.png" alt="Hero" style="max-width:100%; max-height:100%; object-fit:contain;">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Features Section -->
<div class="container py-5">

    <!-- AI Prompts Panel -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card p-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="mb-0"><i class="fas fa-lightbulb text-accent me-2"></i>Suggestions to get you started</h5>
                    <div>
                        <button id="regen-prompts" class="btn btn-sm btn-primary">Regenerate</button>
                    </div>
                </div>
                <div id="ai-prompts-container" class="d-flex gap-3 flex-wrap"></div>
            </div>
        </div>
    </div>

    <!-- Quick Actions Exceptionnelles -->
    <div class="row g-4 mb-5">
        <div class="col-md-4" data-aos="fade-up" data-aos-delay="100">
            <div class="card card-premium h-100 hover-lift">
                <div class="card-body text-center p-4">
                    <div class="feature-icon feature-icon-accent mb-4">
                        <div class="icon-wrapper">
                            <i class="fas fa-microphone"></i>
                        </div>
                    </div>
                    <h5 class="card-title fw-bold">{% trans "Voice Recording" %}</h5>
                    <p class="card-text text-muted">
                        {% trans "Record your thoughts and let AI transcribe them into beautiful journal entries." %}
                    </p>
                    <a href="{% url 'journal_create' %}" class="btn btn-accent shimmer">
                        <i class="fas fa-microphone me-2"></i>{% trans "Start Recording" %}
                    </a>
                </div>
            </div>
        </div>
        
        <div class="col-md-4" data-aos="fade-up" data-aos-delay="200">
            <div class="card card-premium h-100 hover-lift">
                <div class="card-body text-center p-4">
                    <div class="feature-icon feature-icon-accent mb-4">
                        <div class="icon-wrapper">
                            <i class="fas fa-camera"></i>
                        </div>
                    </div>
                    <h5 class="card-title fw-bold">{% trans "Smart Photos" %}</h5>
                    <p class="card-text text-muted">
                        {% trans "Upload photos and get AI-powered descriptions and automatic organization." %}
                    </p>
                    <a href="#" class="btn btn-accent shimmer">
                        <i class="fas fa-upload me-2"></i>{% trans "Upload Photos" %}
                    </a>
                </div>
            </div>
        </div>
        
        <div class="col-md-4" data-aos="fade-up" data-aos-delay="300">
            <div class="card card-premium h-100 hover-lift">
                <div class="card-body text-center p-4">
                    <div class="feature-icon feature-icon-accent mb-4">
                        <div class="icon-wrapper">
                            <i class="fas fa-brain"></i>
                        </div>
                    </div>
                    <h5 class="card-title fw-bold">{% trans "AI Insights" %}</h5>
                    <p class="card-text text-muted">
                        {% trans "Get intelligent summaries, mood analysis, and discover patterns in your memories." %}
                    </p>
                    <a href="#" class="btn btn-accent shimmer">
                        <i class="fas fa-chart-line me-2"></i>{% trans "View Insights" %}
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Categories & Tags Management -->
    <div class="row g-4 mb-5">
        <!-- Categories Section -->
        <div class="col-lg-6">
            <div class="card card-premium h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-folder text-primary me-2"></i>{% trans "Categories" %}
                    </h4>
                    <button class="btn btn-primary btn-sm" onclick="showCategoryForm()">
                        <i class="fas fa-plus me-1"></i>{% trans "Add" %}
                    </button>
                </div>
                <div class="card-body">
                    <div id="categories-list">
                        <!-- Categories will be loaded here -->
                        <div class="text-center py-3">
                            <i class="fas fa-folder fa-2x text-muted mb-2"></i>
                            <p class="text-muted">{% trans "No categories yet" %}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tags Section -->
        <div class="col-lg-6">
            <div class="card card-premium h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-tag text-success me-2"></i>{% trans "Tags" %}
                    </h4>
                    <button class="btn btn-primary btn-sm" onclick="showTagForm()">
                        <i class="fas fa-plus me-1"></i>{% trans "Add" %}
                    </button>
                </div>
                <div class="card-body">
                    <div id="tags-list">
                        <!-- Tags will be loaded here -->
                        <div class="text-center py-3">
                            <i class="fas fa-tag fa-2x text-muted mb-2"></i>
                            <p class="text-muted">{% trans "No tags yet" %}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Entries -->
    <div class="card">
        <div class="card-body">
            <h3 class="card-title mb-4">{% trans "Recent Entries" %}</h3>

            <div id="recent-entries-container">
                <div id="recent-entries-list" class="row g-3">
                    <!-- Recent entries will be injected here by JS -->
                    <div class="col-12 text-center py-5" id="recent-entries-placeholder">
                        <i class="fas fa-book-open fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">{% trans "No entries yet" %}</h5>
                        <p class="text-muted mb-4">{% trans "Start your journey by creating your first journal entry." %}</p>
                        <a href="{% url 'journal_create' %}" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>{% trans "Create First Entry" %}
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Category Modal -->
<div class="modal fade" id="categoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-folder text-primary me-2"></i>{% trans "Category" %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="categoryForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="categoryName" class="form-label">{% trans "Name" %}</label>
                        <input type="text" class="form-control" id="categoryName" required>
                    </div>
                    <div class="mb-3">
                        <label for="categoryColor" class="form-label">{% trans "Color" %}</label>
                        <input type="color" class="form-control form-control-color" id="categoryColor" value="#4a90e2">
                    </div>
                    <div class="mb-3">
                        <label for="categoryIcon" class="form-label">{% trans "Icon" %} ({% trans "optional" %})</label>
                        <input type="text" class="form-control" id="categoryIcon" placeholder="e.g., home, work, heart">
                    </div>
                    <div class="mb-3">
                        <label for="categoryDescription" class="form-label">{% trans "Description" %} ({% trans "optional" %})</label>
                        <textarea class="form-control" id="categoryDescription" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>{% trans "Save" %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Tag Modal -->
<div class="modal fade" id="tagModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-tag text-success me-2"></i>{% trans "Tag" %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="tagForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="tagName" class="form-label">{% trans "Name" %}</label>
                        <input type="text" class="form-control" id="tagName" required>
                        <div class="form-text">{% trans "Tag name will be automatically converted to lowercase." %}</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>{% trans "Save" %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Category management
function showCategoryForm() {
    document.getElementById('categoryForm').reset();
    document.getElementById('categoryColor').value = '#4a90e2';
    new bootstrap.Modal(document.getElementById('categoryModal')).show();
}

function showTagForm() {
    document.getElementById('tagForm').reset();
    new bootstrap.Modal(document.getElementById('tagModal')).show();
}

// Load categories and tags on page load
document.addEventListener('DOMContentLoaded', function() {
    loadCategories();
    loadTags();
});

// Category form submission
document.getElementById('categoryForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData();
    formData.append('name', document.getElementById('categoryName').value);
    formData.append('color', document.getElementById('categoryColor').value);
    formData.append('icon', document.getElementById('categoryIcon').value);
    formData.append('description', document.getElementById('categoryDescription').value);
    
    fetch('/api/categories/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.id) {
            bootstrap.Modal.getInstance(document.getElementById('categoryModal')).hide();
            loadCategories();
            showMessage('Category created successfully!', 'success');
        } else {
            showMessage('Error creating category', 'danger');
        }
    });
});

// Tag form submission
document.getElementById('tagForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData();
    formData.append('name', document.getElementById('tagName').value);
    
    fetch('/api/tags/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.id) {
            bootstrap.Modal.getInstance(document.getElementById('tagModal')).hide();
            loadTags();
            showMessage('Tag created successfully!', 'success');
        } else {
            showMessage('Error creating tag', 'danger');
        }
    });
});

// Load categories
function loadCategories() {
    fetch('/api/categories/')
    .then(response => response.json())
    .then(data => {
        const container = document.getElementById('categories-list');
        if (data.results && data.results.length > 0) {
            container.innerHTML = data.results.map(category => `
                <div class="d-flex align-items-center justify-content-between mb-2 p-2 border rounded">
                    <div class="d-flex align-items-center">
                        <span class="badge me-2" style="background-color: ${category.color}; width: 20px; height: 20px; border-radius: 50%;"></span>
                        <span class="fw-bold">${category.name}</span>
                        ${category.icon ? `<i class="fas fa-${category.icon} ms-2 text-muted"></i>` : ''}
                    </div>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-sm btn-lavender" onclick="editCategory(${category.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-lavender" onclick="deleteCategory(${category.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        } else {
            container.innerHTML = `
                <div class="text-center py-3">
                    <i class="fas fa-folder fa-2x text-muted mb-2"></i>
                    <p class="text-muted">No categories yet</p>
                </div>
            `;
        }
    });
}

// Load tags
function loadTags() {
    fetch('/api/tags/')
    .then(response => response.json())
    .then(data => {
        const container = document.getElementById('tags-list');
        if (data.results && data.results.length > 0) {
            container.innerHTML = data.results.map(tag => `
                <div class="d-flex align-items-center justify-content-between mb-2 p-2 border rounded">
                    <div class="d-flex align-items-center">
                        <span class="badge bg-primary me-2">${tag.name}</span>
                        <small class="text-muted">${tag.usage_count} uses</small>
                    </div>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-sm btn-lavender" onclick="editTag(${tag.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-lavender" onclick="deleteTag(${tag.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        } else {
            container.innerHTML = `
                <div class="text-center py-3">
                    <i class="fas fa-tag fa-2x text-muted mb-2"></i>
                    <p class="text-muted">No tags yet</p>
                </div>
            `;
        }
    });
}

// Utility functions
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showMessage(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.container').firstChild);
    setTimeout(() => alertDiv.remove(), 5000);
}

// Placeholder functions for edit/delete
function editCategory(id) {
    showMessage('Edit functionality coming soon!', 'info');
}

function deleteCategory(id) {
    if (confirm('Are you sure you want to delete this category?')) {
        fetch(`/api/categories/${id}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(() => {
            loadCategories();
            showMessage('Category deleted successfully!', 'success');
        });
    }
}

function editTag(id) {
    showMessage('Edit functionality coming soon!', 'info');
}

function deleteTag(id) {
    if (confirm('Are you sure you want to delete this tag?')) {
        fetch(`/api/tags/${id}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(() => {
            loadTags();
            showMessage('Tag deleted successfully!', 'success');
        });
    }
}
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
    const container = document.getElementById('ai-prompts-container');
    const regenBtn = document.getElementById('regen-prompts');

    function renderPrompts(list){
        container.innerHTML = '';
        const pastel = ['#fef6ff', '#f1f8ff', '#fef9ef', '#f6f4ff'];
        list.forEach((p, idx)=>{
            const card = document.createElement('div');
            card.className = 'prompt-card';
            card.style.background = pastel[idx % pastel.length];
            card.innerHTML = `
                <div class="small text-muted mb-2">Prompt</div>
                <div class="fw-semibold mb-3">${p}</div>
                <div class="d-flex justify-content-end">
                    <button class="btn btn-sm btn-accent use-prompt">Use</button>
                </div>
            `;
            card.addEventListener('click', function(e){
                // clicking anywhere acts like using the prompt
                const url = '{% url "journal_create" %}';
                window.location.href = url + '?prompt=' + encodeURIComponent(p);
            });
            // allow the small button to stop propagation (optional)
            container.appendChild(card);
        });
    }

    function loadPrompts(){
        fetch('{% url "journal_ai_prompts" %}')
            .then(r=>r.json())
            .then(data=>{
                renderPrompts(data || []);
            }).catch(err=>{
                console.error('AI prompts error', err);
            });
    }

    if(container){ loadPrompts(); }
    if(regenBtn){ regenBtn.addEventListener('click', function(){ loadPrompts(); }); }
});
</script>
    <script>
    // Fetch three recent entries and render them in the Recent Entries card
    document.addEventListener('DOMContentLoaded', function(){
        async function loadRecentEntries(limit = 3){
            try{
                const resp = await fetch('{% url "journal_garden_data" %}?days=365');
                if(!resp.ok) throw new Error('Network response was not ok');
                const data = await resp.json();
                const list = (Array.isArray(data) ? data : []).slice(0, limit);
                const container = document.getElementById('recent-entries-list');
                const placeholder = document.getElementById('recent-entries-placeholder');
                if(!container) return;
                if(placeholder) placeholder.remove();
                if(list.length === 0){
                    container.innerHTML = `
                        <div class="col-12 text-center py-5">
                            <i class="fas fa-book-open fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No entries yet</h5>
                            <p class="text-muted mb-4">Start your journey by creating your first journal entry.</p>
                            <a href="{% url 'journal_create' %}" class="btn btn-primary"><i class="fas fa-plus me-2"></i>Create First Entry</a>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = list.map(entry => {
                    const title = entry.title || (entry.snippet ? entry.snippet : 'Untitled');
                    const date = entry.entry_date ? new Date(entry.entry_date).toLocaleDateString() : (entry.created_at ? new Date(entry.created_at).toLocaleDateString() : '');
                    const mood = entry.mood || 'neutral';
                    const snippet = entry.snippet || '';
                    const hasImages = entry.images && entry.images.length > 0;
                    const firstImage = hasImages ? entry.images[0] : null;
                    return `
                        <div class="col-md-4 col-sm-6">
                            <div class="card h-100 ${hasImages ? 'p-0' : 'p-3'}">
                                ${hasImages ? `
                                    <img src="${firstImage}" class="card-img-top" alt="${escapeHtml(title)}" style="height: 200px; object-fit: cover;">
                                    <div class="card-body p-3">
                                ` : ''}
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1 fw-semibold">${escapeHtml(title)}</h6>
                                        <small class="text-muted">${date}</small>
                                    </div>
                                    <div>
                                        <a href="/journals/${entry.id}/" class="btn btn-sm btn-lavender ms-2" title="Open"><i class="fas fa-external-link-alt"></i></a>
                                    </div>
                                </div>
                                <p class="small text-muted mt-2">${escapeHtml(snippet)}</p>
                                ${hasImages ? '</div>' : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }catch(err){
                console.error('Failed to load recent entries', err);
            }
        }

        // small helper to prevent XSS in injected strings
        function escapeHtml(str){
            if(!str) return '';
            return String(str).replace(/[&<>"']/g, function(s){
                return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]);
            });
        }

        loadRecentEntries(3);
    });
    </script>
{% endblock %}
